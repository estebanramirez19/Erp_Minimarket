{% extends 'base.html' %}
{% block contenido %}
<div class="mb-4">
    <!-- ENCABEZADO -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0"><i class="bi bi-pencil-square"></i> Editar Compra</h1>
            <small class="text-secondary">Folio: {{ compra.folio|default:"—" }}</small>
        </div>
        <a href="{% url 'compras:lista_compras' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="editar-compra-form">
        {% csrf_token %}
        
        <!-- Datos generales -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Proveedor</h5>
            </div>
            <div class="card-body">
                {{ form.as_p }}
            </div>
        </div>
        
        <!-- Detalles de compra (manual) -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Productos de la Compra</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para agregar -->
                <form id="form-agregar-detalle" class="form-agregar-detalle mb-4">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="codigo-input" placeholder="Código barra">
                        </div>
                        <div class="col-md-4 position-relative autocomplete-container">
                            <input type="text" class="form-control" id="nombre-input" placeholder="Buscar o crear..." autocomplete="off">
                            <div id="sugerencias" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="cantidad-input" placeholder="0" min="1" step="1">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="precio-input" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-success w-100" id="agregar-btn" title="Agregar producto">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Tabla de detalles temporales -->
                <div class="table-responsive">
                    <table class="tabla-detalles">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th class="cantidad">Cantidad</th>
                                <th class="precio text-end">Precio Unitario</th>
                                <th class="precio text-end">Subtotal</th>
                                <th class="acciones">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="detalles-tabla">
                            <!-- Se llena dinámicamente con JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RESUMEN DE TOTALES -->
        <div class="resumen-totales mb-4">
            <div class="total-row">
                <span class="total-label">Subtotal:</span>
                <span class="total-valor">$<span id="compra-subtotal">0</span></span>
            </div>
            <div class="total-row">
                <span class="total-label">IVA (19%):</span>
                <span class="total-valor">$<span id="compra-iva">0</span></span>
            </div>
            <div class="total-row">
                <span class="total-label">Total:</span>
                <span class="total-valor">$<span id="compra-total">0</span></span>
            </div>
        </div>

        <!-- BOTONES DE ACCIÓN -->
        <div class="d-flex gap-2 justify-content-end">
            <a href="{% url 'compras:lista_compras' %}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-warning btn-lg" name="submit_compra">
                <i class="bi bi-check-circle"></i> Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
    let detallesTemp = {{ detalles_temp|safe }};
    let highlightedSuggestion = -1;

    // Cargar detalles existentes en la tabla
    function cargarDetallesEnTabla() {
        const tbody = document.getElementById('detalles-tabla');
        tbody.innerHTML = '';
        detallesTemp.forEach((d, idx) => {
            const subtotal = (d.cantidad * d.precio_unitario).toFixed(0);
            const row = `
                <tr>
                    <td>${d.producto_codigo || '—'}</td>
                    <td class="producto-nombre">${d.producto_nombre}</td>
                    <td class="cantidad">${d.cantidad}</td>
                    <td class="precio text-end">$${parseFloat(d.precio_unitario).toFixed(0)}</td>
                    <td class="precio text-end">$${subtotal}</td>
                    <td class="acciones">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarDetalle(${idx})" title="Eliminar producto">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        actualizarTotales();
    }

    // Actualizar totales
    function actualizarTotales() {
        let subtotal = 0;
        detallesTemp.forEach(d => {
            subtotal += d.cantidad * d.precio_unitario;
        });
        const iva = (subtotal * 0.19).toFixed(0);
        const total = (parseFloat(subtotal) + parseFloat(iva)).toFixed(0);
        
        document.getElementById('compra-subtotal').textContent = subtotal.toFixed(0);
        document.getElementById('compra-iva').textContent = iva;
        document.getElementById('compra-total').textContent = total;
    }

    // Buscar productos
    function fetchSuggestions(query) {
        if (!query || query.length < 2) {
            document.getElementById('sugerencias').classList.add('hidden');
            return;
        }
        fetch(`/compras/buscar-productos/?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => renderSuggestions(data.results || []))
            .catch(e => console.error(e));
    }

    // Renderizar sugerencias
    function renderSuggestions(results) {
        const div = document.getElementById('sugerencias');
        if (results.length === 0) {
            div.classList.add('hidden');
            return;
        }
        div.innerHTML = results.map((p, idx) => `
            <div class="suggestion-item" onclick="selectProduct('${p.id}', '${p.codigo_barra}', '${p.nombre}', '${p.precio_compra}');">
                <span class="suggestion-nombre">${p.nombre}</span>
                <span class="suggestion-codigo">${p.codigo_barra || 'sin código'}</span>
                <span class="suggestion-precio">$${parseFloat(p.precio_compra || 0).toFixed(0)}</span>
            </div>
        `).join('');
        div.classList.remove('hidden');
        highlightedSuggestion = -1;
    }

    // Seleccionar producto
    function selectProduct(id, codigo, nombre, precio) {
        document.getElementById('codigo-input').value = codigo;
        document.getElementById('nombre-input').value = nombre;
        document.getElementById('precio-input').value = parseFloat(precio).toFixed(2);
        document.getElementById('sugerencias').classList.add('hidden');
        document.getElementById('cantidad-input').focus();
    }

    // Detección de paste
    document.getElementById('codigo-input').addEventListener('paste', function(e) {
        setTimeout(() => {
            const codigo = this.value.trim();
            if (codigo) {
                fetch(`/compras/buscar-productos/?q=${encodeURIComponent(codigo)}`)
                    .then(r => r.json())
                    .then(data => {
                        const results = data.results || [];
                        if (results.length === 1) {
                            selectProduct(results[0].id, results[0].codigo_barra, results[0].nombre, results[0].precio_compra);
                        } else if (results.length > 1) {
                            renderSuggestions(results);
                        }
                    });
            }
        }, 10);
    });

    // Autocomplete en nombre
    let debounceTimer;
    document.getElementById('nombre-input').addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fetchSuggestions(this.value), 150);
    });

    // Navegación por teclado
    document.getElementById('nombre-input').addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('#sugerencias .suggestion-item');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightedSuggestion = Math.min(highlightedSuggestion + 1, items.length - 1);
            highlightSuggestion(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightedSuggestion = Math.max(highlightedSuggestion - 1, -1);
            highlightSuggestion(items);
        } else if (e.key === 'Enter' && highlightedSuggestion >= 0) {
            e.preventDefault();
            items[highlightedSuggestion].click();
        }
    });

    function highlightSuggestion(items) {
        items.forEach((item, idx) => {
            item.classList.toggle('active', idx === highlightedSuggestion);
        });
    }

    // Agregar detalle
    document.getElementById('agregar-btn').addEventListener('click', async function() {
        const codigo = document.getElementById('codigo-input').value.trim();
        const nombre = document.getElementById('nombre-input').value.trim();
        const cantidad = parseInt(document.getElementById('cantidad-input').value) || 0;
        const precio = parseFloat(document.getElementById('precio-input').value) || 0;

        if (!nombre || cantidad <= 0 || precio < 0) {
            alert('Por favor completa todos los campos correctamente');
            return;
        }

        try {
            const resp = await fetch('/compras/agregar-detalle-edit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    producto_codigo: codigo,
                    producto_nombre: nombre,
                    cantidad: cantidad,
                    precio_unitario: precio
                })
            });

            if (resp.ok) {
                const data = await resp.json();
                // Agregar el nuevo detalle a la array local
                detallesTemp.push(data.detalle);
                // Actualizar la tabla
                cargarDetallesEnTabla();
                // Limpiar inputs
                document.getElementById('codigo-input').value = '';
                document.getElementById('nombre-input').value = '';
                document.getElementById('cantidad-input').value = '';
                document.getElementById('precio-input').value = '';
                document.getElementById('sugerencias').classList.add('hidden');
            } else {
                const error = await resp.json();
                alert('Error: ' + error.error);
            }
        } catch (e) {
            console.error(e);
        }
    });

    // Quitar detalle
    function quitarDetalle(idx) {
        fetch(`/compras/quitar-detalle-edit/${idx}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(r => r.json()).then(data => {
            if (data.success) {
                // Remover del array local
                detallesTemp.splice(idx, 1);
                // Reindexar temp_id de todos los detalles
                detallesTemp.forEach((d, i) => d.temp_id = i);
                // Actualizar la tabla
                cargarDetallesEnTabla();
            }
        }).catch(e => console.error(e));
    }

    // Enter en cantidad para agregar
    document.getElementById('cantidad-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('agregar-btn').click();
        }
    });

    // Cargar detalles iniciales
    cargarDetallesEnTabla();
</script>
{% endblock %}
